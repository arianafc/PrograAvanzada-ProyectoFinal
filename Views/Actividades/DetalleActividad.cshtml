@model ProyectoFinal.EF.DetalleActividadSP_Result

@{
    ViewBag.Title = "Detalles de " + Model.NOMBRE;
}

<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-white shadow-sm rounded">
                    <li class="breadcrumb-item">
                        @Html.ActionLink("Actividades", "ActividadesDisponibles", "Actividades")
                    </li>
                    <li class="breadcrumb-item active">@Model.NOMBRE</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Imagen -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <img src="@Url.Content("~/" + Model.IMAGEN)" alt="@Model.NOMBRE" class="img-fluid rounded-top" />
            </div>
        </div>

        <!-- Información -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="card-title">@Model.NOMBRE</h2>

                    <span class="badge
                        @(Model.TIPO.ToLower() == "evento" ? "bg-primary" : Model.TIPO.ToLower() == "tour" ? "bg-warning text-dark" : "bg-secondary")
                        text-uppercase mb-3">
                        @Model.TIPO
                    </span>

                    <p class="mt-3"><strong>Descripción:</strong><br />@Model.DESCRIPCION</p>
                    <p><strong>Fecha:</strong> @Model.FECHA.ToString("dd/MM/yyyy")</p>
                    <p><strong>Hora:</strong> @Model.FECHA.ToShortTimeString()</p>
                    <p><strong>Tickets disponibles:</strong> <span id="disponibles">@Model.TICKETS_DISPONIBLES</span></p>
                    <p><strong>Precio unitario:</strong> ₡@String.Format("{0:N0}", Model.PRECIO_BOLETO)</p>
                    <hr />

                    <!-- Cantidad de boletos -->
                    <div class="form-group mt-3">
                        <label for="cantidadBoletos">Cantidad de boletos</label>
                        <input type="number" class="form-control" id="cantidadBoletos" min="1" max="@Model.TICKETS_DISPONIBLES" value="1" />
                    </div>

                    <!-- Método de pago -->
                    <div class="form-group mt-3">
                        <label for="metodo">Selecciona un método de pago</label>
                        <select class="form-select" id="metodo">
                            <option value="">-- Selecciona --</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="sinpe">SINPE</option>
                            <option value="paypal">PayPal</option>
                        </select>
                    </div>

                    <p class="mt-2"><strong>Subtotal:</strong> ₡<span id="subtotal">@(Model.PRECIO_BOLETO.ToString("N0"))</span></p>

                    <button type="button" class="btn btn-participar mt-3 w-100" onclick="mostrarModal(@Model.ID_ACTIVIDAD)">
                        COMPRAR BOLETOS
                    </button>

                    @using (Html.BeginForm("ComprarBoletos", "Actividades", FormMethod.Post))
                    {
                        @Html.Hidden("IdActividad", Model.ID_ACTIVIDAD)
                        @Html.Hidden("MetodoPago", null, new { id = "inputMetodoPago" })
                        @Html.Hidden("NumBoletos", null, new { id = "inputNumBoletos" })
                        @Html.Hidden("Referencia", null, new { id = "inputReferencia" })
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALES -->
<!-- Modal Tarjeta -->
<div class="modal fade" id="modalTarjeta" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pago con Tarjeta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input class="form-control mb-2" id="numeroTarjeta" placeholder="Número tarjeta" />
                <input class="form-control mb-2" id="titularTarjeta" placeholder="Titular" />
                <input class="form-control mb-2" id="codigoSeguridad" placeholder="Código seguridad" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="enviarFormularioCompra(1)">Pagar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSinpe" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pago por Sinpe Móvil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Realice su Sinpe al número: <strong>70265643</strong></p>
                <p>Nombre del titular: <strong>Casa Natura</strong></p>
                <div class="mb-3">
                    <label for="referencia" class="form-label fw-bold">Número de referencia Sinpe</label>
                    <input type="text" id="referenciaActividad" name="referencia" class="form-control"
                           placeholder="Digite el número de referencia"
                           pattern="^\d{6,30}$"
                           title="Solo números, mínimo 6 dígitos" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-participar" onclick="enviarFormularioCompra(2)">Pagar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal PayPal -->
<div class="modal fade" id="modalPaypal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pago con PayPal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input class="form-control mb-2" id="usuarioPaypal" placeholder="Correo o usuario" />
                <input class="form-control mb-2" type="password" id="contrasenaPaypal" placeholder="Contraseña" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="enviarFormularioCompra(3)">Pagar</button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
@section Scripts {
    <script>
    const precioUnitario = @Model.PRECIO_BOLETO;
    const maxDisponibles = @Model.TICKETS_DISPONIBLES;

    document.addEventListener("DOMContentLoaded", function () {
        const cantidadInput = document.getElementById("cantidadBoletos");
        const subtotalSpan = document.getElementById("subtotal");

        cantidadInput.addEventListener("input", function () {
            let cantidad = parseInt(this.value);
            if (cantidad > maxDisponibles) {
                Swal.fire({
                    icon: 'error',
                    title: 'Cantidad no válida',
                    text: 'La cantidad no puede ser mayor a los boletos disponibles.',
                    confirmButtonColor: '#dc3545'
                });
                this.value = maxDisponibles;
                cantidad = maxDisponibles;
            }
            const subtotal = cantidad * precioUnitario;
            subtotalSpan.textContent = subtotal.toLocaleString('es-CR');
        });
    });

    function mostrarModal(idActividad) {
        const metodo = document.getElementById("metodo").value;
        if (!metodo) {
            Swal.fire({
                icon: 'warning',
                title: 'Selecciona un método de pago',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        switch (metodo) {
            case "tarjeta":
                new bootstrap.Modal(document.getElementById("modalTarjeta")).show();
                break;
            case "sinpe":
                new bootstrap.Modal(document.getElementById("modalSinpe")).show();
                break;
            case "paypal":
                new bootstrap.Modal(document.getElementById("modalPaypal")).show();
                break;
        }
    }

    function enviarFormularioCompra(metodoPagoId) {
        const cantidad = parseInt(document.getElementById("cantidadBoletos").value);

        if (!cantidad || cantidad <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Cantidad inválida',
                text: 'La cantidad debe ser mayor a cero.'
            });
            return;
        }


        if (metodoPagoId === 1) {
            const numero = document.getElementById("numeroTarjeta").value;
            const titular = document.getElementById("titularTarjeta").value;
            const codigo = document.getElementById("codigoSeguridad").value;
            if (!numero || !titular || !codigo) {
                alert("Completa todos los campos de tarjeta.");
                return;
            }
            bootstrap.Modal.getInstance(document.getElementById("modalTarjeta")).hide();
        }

        if (metodoPagoId === 2) {
            const ref = document.getElementById("referenciaActividad").value;

            if (!/^\d{6,30}$/.test(ref)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Referencia SINPE inválida',
                    text: 'Debe ser numérica y tener al menos 6 dígitos.',
                });
                return;
            }

            document.getElementById("inputReferencia").value = ref;
            bootstrap.Modal.getInstance(document.getElementById("modalSinpe")).hide();
        }

        if (metodoPagoId === 3) {
            const u = document.getElementById("usuarioPaypal").value;
            const p = document.getElementById("contrasenaPaypal").value;
            if (!u || !p) {
                alert("Completa los datos de PayPal.");
                return;
            }
            bootstrap.Modal.getInstance(document.getElementById("modalPaypal")).hide();
        }

        document.getElementById("inputMetodoPago").value = metodoPagoId;
        document.getElementById("inputNumBoletos").value = cantidad;

        document.forms[0].submit();
        }


                 @if (TempData["SwalSuccess"] != null)
            {
                <text>
                    Swal.fire({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: '@Html.Raw(HttpUtility.JavaScriptStringEncode(TempData["SwalSuccess"].ToString()))',
                        confirmButtonColor: '#3085d6'
                    });
                </text>
            }

            @if (TempData["SwalError"] != null)
            {
                <text>
                    Swal.fire({
                        icon: 'error',
                        title: '¡Error!',
                         text: '@Html.Raw(HttpUtility.JavaScriptStringEncode(TempData["SwalError"].ToString()))',
                        confirmButtonColor: '#d33'
                    });
                </text>
            }
    </script>
}
